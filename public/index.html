<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Gemini Chat</title>
    <style>
      body {
        font-family: Arial;
        margin: 0;
        padding: 0;
        background: #f6f8fb;
      }
      .container-center {
        max-width: 1100px;
        margin: 0 auto;
        padding: 40px 12px 0 12px;
      }
      h2 {
        text-align: center;
      }
      .subtitle {
        color: #6c7a89;
        margin-bottom: 24px;
        font-size: 1.1em;
        text-align: center;
      }
      #main-flex {
        display: flex;
        gap: 32px;
        align-items: flex-start;
        justify-content: center;
        min-height: 80vh;
        background: #f6f8fb;
        padding: 32px 0;
      }
      #questionnaire {
        flex: 1;
        min-width: 320px;
        max-width: 400px;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 16px #0001;
        padding: 32px 28px;
        margin: 0 auto;
      }
      #result {
        flex: 2;
        min-width: 340px;
        max-width: 700px;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 16px #0001;
        padding: 32px 28px;
        margin: 0 auto;
      }
      /* Responsive cho tablet v√† mobile */
      @media (max-width: 900px) {
        #main-flex {
          flex-direction: column;
          align-items: stretch;
          gap: 24px;
          padding: 16px 0;
        }
        #questionnaire,
        #result {
          max-width: 100%;
          min-width: 0;
          width: 100%;
          margin: 0 auto;
        }
      }
      @media (max-width: 600px) {
        .container-center {
          padding: 16px 2px 0 2px;
        }
        #main-flex {
          padding: 8px 0;
        }
        #questionnaire,
        #result {
          padding: 16px 6px;
          border-radius: 8px;
          font-size: 1em;
        }
      }
      body {
        font-family: Arial;
        margin: 40px;
      }
      #chat {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
      }
      #input {
        width: 80%;
      }
      #send {
        width: 15%;
      }
      .user {
        color: blue;
      }
      .bot {
        color: green;
      }
      .dynamic-option {
        display: block;
        margin: 10px 0;
        padding: 16px 20px;
        background: #f7faff;
        border: 2px solid #2a5d9f;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 500;
        color: #2a5d9f;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, border 0.2s;
        box-shadow: 0 2px 8px #0001;
      }
      .dynamic-option:hover {
        background: #2a5d9f;
        color: #fff;
        border-color: #17406a;
      }
      .dynamic-option.selected {
        background: #17406a;
        color: #fff;
        border-color: #17406a;
      }
      .answered {
        opacity: 0.7;
        pointer-events: none;
      }
      .question-progress {
        margin-bottom: 12px;
        color: #888;
        font-size: 0.98em;
      }
      #result .article-html {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 24px;
        margin-top: 16px;
        box-shadow: 0 2px 8px #0001;
        max-width: 700px;
        line-height: 1.7;
      }
      #result .article-html h1,
      #result .article-html h2,
      #result .article-html h3 {
        color: #2a5d9f;
        margin-top: 0;
      }
      #result .article-html ul,
      #result .article-html ol {
        margin-left: 24px;
      }
      #result .article-html strong {
        color: #d2691e;
      }
      #result .article-html em {
        color: #008080;
      }
      #result .article-html .hashtags {
        color: #0077cc;
        font-weight: bold;
        margin-top: 12px;
        display: block;
      }
      #main-flex {
        display: flex;
        gap: 32px;
        align-items: flex-start;
      }
      #questionnaire {
        flex: 1;
        min-width: 320px;
        max-width: 420px;
      }
      #result {
        flex: 2;
        min-width: 340px;
        max-width: 700px;
      }
    </style>
  </head>
  <body>
    <div class="container-center">
      <h2 style="margin-bottom: 0">AI Writer Assistant</h2>
      <div class="subtitle">Tr·ª£ l√Ω vi·∫øt n·ªôi dung b·∫•t ƒë·ªông s·∫£n th√¥ng minh</div>
      <div id="main-flex">
        <div id="questionnaire" class="card">
          <!-- N·ªôi dung input s·∫Ω render ·ªü ƒë√¢y -->
        </div>
        <div id="result">
          <!-- K·∫øt qu·∫£ AI s·∫Ω render ·ªü ƒë√¢y -->
        </div>
      </div>
    </div>
    <script>
      const questionnaire = document.getElementById("questionnaire");
      const resultDiv = document.getElementById("result");
      const fixedTopics = [
        "Gi·ªõi thi·ªáu v·ªÅ AI",
        "ƒê√°m c∆∞·ªõi",
        "Du l·ªãch ƒê√† L·∫°t",
        "S·∫£n ph·∫©m m·ªõi",
        "Kinh nghi·ªám h·ªçc t·∫≠p",
      ];
      let selectedTopic = "";
      let questions = [];
      let answers = [];
      let currentQuestion = 0;
      let tone = "";

      function renderTopics() {
        // Ch·ªâ gi·ªØ l·∫°i n√∫t ph√¢n t√≠ch tin b·∫•t ƒë·ªông s·∫£n
        questionnaire.innerHTML = "<p>B·∫°n mu·ªën vi·∫øt v·ªÅ ch·ªß ƒë·ªÅ n√†o?</p>";
        const realEstateBtn = document.createElement("button");
        realEstateBtn.textContent = "Ph√¢n t√≠ch tin b·∫•t ƒë·ªông s·∫£n";
        realEstateBtn.className = "dynamic-option";
        realEstateBtn.style.background = "#ffe082";
        realEstateBtn.style.color = "#333";
        realEstateBtn.onclick = renderRealEstateForm;
        questionnaire.appendChild(realEstateBtn);
      }

      // Giao di·ªán nh·∫≠p tin b·∫•t ƒë·ªông s·∫£n
      function renderRealEstateForm() {
        questionnaire.innerHTML = `
          <div style="font-size:1.18em;font-weight:600;margin-bottom:18px;">Th√¥ng tin tin cƒÉn h·ªô</div>
          <textarea id="realEstateInput" rows="10" style="width:100%;font-size:1.08em;padding:12px;border-radius:8px;border:1.5px solid #dbeafe;background:#f8fafc;margin-bottom:16px;resize:vertical;" placeholder="Nh·∫≠p n·ªôi dung tin b·∫•t ƒë·ªông s·∫£n c·∫ßn ph√¢n t√≠ch..."></textarea>
          <div style="margin-bottom:18px;">
            <button id="analyzeBtn" class="dynamic-option" style="width:100%;background:#2a5d9f;color:#fff;font-weight:600;font-size:1.1em;margin-bottom:8px;">&#128202; Ph√¢n t√≠ch</button>
            <button id="backBtn" class="dynamic-option" style="width:100%;background:#f5f5f5;color:#333;border-color:#bbb;">&#8592; Quay l·∫°i</button>
          </div>
        `;
        document.getElementById("analyzeBtn").onclick = async () => {
          const content = document
            .getElementById("realEstateInput")
            .value.trim();
          if (!content) return;
          resultDiv.innerHTML =
            "<div style='padding:32px;text-align:center;color:#888;font-size:1.1em'><i>ƒêang ph√¢n t√≠ch v·ªõi AI...</i></div>";
          try {
            const res = await fetch("/analyze-real-estate", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ content }),
            });
            // Ki·ªÉm tra HTTP status
            if (!res.ok) {
              resultDiv.innerHTML =
                "<div style='padding:32px;text-align:center;color:#e57373;font-size:1.1em'>L·ªói khi k·∫øt n·ªëi API.</div>";
              return;
            }
            const data = await res.json();
            // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p hashtag l√† m·∫£ng ho·∫∑c chu·ªói
            let hashtags = "";
            if (data && data.result) {
              if (Array.isArray(data.result.hashtag)) {
                hashtags = data.result.hashtag.slice(0, 5).join(" ");
              } else if (typeof data.result.hashtag === "string") {
                hashtags = data.result.hashtag
                  .split(/[\s#]+/)
                  .filter(Boolean)
                  .map((h) => (h.startsWith("#") ? h : "#" + h))
                  .slice(0, 5)
                  .join(" ");
              }
              // Hi·ªÉn th·ªã k·∫øt qu·∫£ ph√¢n t√≠ch v·ªõi style ƒë·∫πp
              let html = "";
              if (data.result.title) {
                html += `<div style="font-size:1.35em;font-weight:700;color:#d2691e;display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                  <span style="font-size:1.5em;">üè°</span> ${data.result.title}
                </div>`;
              }
              if (data.result.trend) {
                html += `<div style="background:#fff0f6;border-left:4px solid #e57373;padding:14px 18px;border-radius:8px;margin-bottom:18px;">
                  <b style="color:#e57373;">&#128200; Xu h∆∞·ªõng TikTok:</b><br>${data.result.trend}
                </div>`;
              }
              if (data.result.nearby) {
                html += `<div style="background:#e3f2fd;border-left:4px solid #1976d2;padding:14px 18px;border-radius:8px;margin-bottom:18px;">
                  <b style="color:#1976d2;">&#128205; Ti·ªán √≠ch xung quanh:</b><br>${data.result.nearby}
                </div>`;
              }
              html += `<div style="display:flex;gap:18px;margin-bottom:18px;">`;
              if (data.result.area) {
                html += `<div style="flex:1;background:#e8f5e9;border-radius:8px;padding:14px 16px;">
                  <b style="color:#43a047;">&#128207; Di·ªán t√≠ch ƒë·∫•t:</b><br>
                  <span style="font-size:1.15em;font-weight:600;color:#388e3c">${data.result.area}</span>
                </div>`;
              }
              if (data.result.structure) {
                html += `<div style="flex:1;background:#fffde7;border-radius:8px;padding:14px 16px;">
                  <b style="color:#fbc02d;">&#128736; K·∫øt c·∫•u nh√†:</b><br>
                  <span style="font-size:1.05em;">${data.result.structure}</span>
                </div>`;
              }
              html += `</div>`;
              if (data.result.price) {
                html += `<div style="background:#f3e5f5;border-left:4px solid #8e24aa;padding:14px 18px;border-radius:8px;margin-bottom:18px;">
                  <b style="color:#8e24aa;">&#128181; Gi√° b√°n:</b>
                  <span style="font-size:1.25em;font-weight:700;color:#8e24aa;margin-left:8px;">${data.result.price}</span>
                </div>`;
              }
              if (data.result.contact) {
                html += `<div style="background:#e1f5fe;border-left:4px solid #0288d1;padding:14px 18px;border-radius:8px;margin-bottom:18px;">
                  <b style="color:#0288d1;">&#128222; Li√™n h·ªá:</b><br>${data.result.contact}
                </div>`;
              }
              if (hashtags) {
                html += `<div style="margin-bottom:18px;"><b style="color:#0077cc;"># Hashtag:</b> <span class="hashtags">${hashtags}</span></div>`;
              }
              if (data.result.tiktok_script) {
                html += `<div style="background:#f9fbe7;border-left:4px solid #cddc39;padding:14px 18px;border-radius:8px;margin-bottom:18px;">
                  <b style="color:#afb42b;">&#127916; G·ª£i √Ω k·ªãch b·∫£n quay TikTok:</b><br>${data.result.tiktok_script}
                </div>`;
              }
              resultDiv.innerHTML = html;
            } else {
              resultDiv.innerHTML =
                "<div style='padding:32px;text-align:center;color:#e57373;font-size:1.1em'>L·ªói khi ph√¢n t√≠ch tin b·∫•t ƒë·ªông s·∫£n.</div>";
            }
          } catch (e) {
            resultDiv.innerHTML =
              "<div style='padding:32px;text-align:center;color:#e57373;font-size:1.1em'>L·ªói khi k·∫øt n·ªëi API.</div>";
          }
        };
        document.getElementById("backBtn").onclick = renderTopics;
      }

      async function handleTopic(topic) {
        selectedTopic = topic;
        answers = [];
        currentQuestion = 0;
        document.getElementById("question-list").innerHTML = "";
        questionnaire.innerHTML = `<i>ƒêang l·∫•y 5 c√¢u h·ªèi g·ª£i √Ω...</i>`;
        resultDiv.innerHTML = "";
        // G·ªçi API l·∫•y 5 c√¢u h·ªèi
        const res = await fetch("/suggest-questions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic }),
        });
        const data = await res.json();
        // N·∫øu m·∫£ng tr·∫£ v·ªÅ >5 ph·∫ßn t·ª≠, ch·ªâ l·∫•y 5 ph·∫ßn t·ª≠ cu·ªëi c√πng
        if (Array.isArray(data.questions) && data.questions.length > 5) {
          questions = data.questions.slice(-5);
        } else {
          questions = data.questions || [];
        }
        if (questions.length === 5) {
          renderQuestion(0);
        } else {
          questionnaire.innerHTML = "Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªß 5 c√¢u h·ªèi.";
        }
      }

      // G·ª£i √Ω option m·∫´u cho t·ª´ng c√¢u h·ªèi (c√≥ th·ªÉ t√πy ch·ªânh theo ch·ªß ƒë·ªÅ)
      function getOptionsForQuestion(idx) {
        const optionsList = [
          [
            "AI l√† tr√≠ tu·ªá nh√¢n t·∫°o gi√∫p m√°y m√≥c suy nghƒ© nh∆∞ con ng∆∞·ªùi",
            "AI l√† c√¥ng ngh·ªá m√¥ ph·ªèng tr√≠ tu·ªá con ng∆∞·ªùi",
            "AI l√† h·ªá th·ªëng t·ª± ƒë·ªông h√≥a th√¥ng minh",
          ],
          [
            "Chatbot, xe t·ª± l√°i, ph√¢n t√≠ch d·ªØ li·ªáu",
            "Nh·∫≠n di·ªán khu√¥n m·∫∑t, d·ªãch t·ª± ƒë·ªông, ƒë·ªÅ xu·∫•t s·∫£n ph·∫©m",
            "Robot h·ªó tr·ª£ y t·∫ø, tr·ª£ l√Ω ·∫£o",
          ],
          [
            "TƒÉng nƒÉng su·∫•t, h·ªó tr·ª£ con ng∆∞·ªùi",
            "T·ª± ƒë·ªông h√≥a c√¥ng vi·ªác l·∫∑p l·∫°i",
            "Gi√∫p ra quy·∫øt ƒë·ªãnh nhanh h∆°n",
          ],
          [
            "AI gi√∫p cu·ªôc s·ªëng d·ªÖ d√†ng h∆°n",
            "AI thay ƒë·ªïi c√°ch l√†m vi·ªác v√† h·ªçc t·∫≠p",
            "AI th√∫c ƒë·∫©y ƒë·ªïi m·ªõi s√°ng t·∫°o",
          ],
          [
            "Th√¢n thi·ªán, d·ªÖ hi·ªÉu",
            "Chuy√™n nghi·ªáp, h·ªçc thu·∫≠t",
            "H√†i h∆∞·ªõc, g·∫ßn g≈©i",
          ],
        ];
        return optionsList[idx] || [];
      }

      // Hi·ªÉn th·ªã danh s√°ch c√¢u h·ªèi v√† c√¢u tr·∫£ l·ªùi ƒë√£ ch·ªçn
      function renderQuestionList(currentIdx) {
        const ql = document.getElementById("question-list");
        if (!ql) return;
        let html =
          '<div style="font-weight:bold;font-size:1.1em;margin-bottom:10px;">C√¢u h·ªèi</div>';
        for (let i = 0; i < questions.length; i++) {
          html += `<div style='margin-bottom:12px;${
            i === currentIdx ? "color:#2a5d9f;font-weight:bold;" : ""
          }'>${i + 1}. ${questions[i]}<br>`;
          if (answers[i]) {
            html += `<span style='background:#e3f2fd;border-radius:4px;padding:2px 8px;margin-top:2px;display:inline-block;'>${answers[i]}</span>`;
          }
          html += "</div>";
        }
        ql.innerHTML = html;
      }

      function renderQuestion(idx) {
        renderQuestionList(idx);
        questionnaire.innerHTML = `<div class='question-progress'>C√¢u h·ªèi ${
          idx + 1
        }/5</div><p>${questions[idx]}</p>`;
        const options = getOptionsForQuestion(idx);
        let selected = null;
        if (options.length > 0) {
          options.forEach((opt) => {
            const btn = document.createElement("button");
            btn.textContent = opt;
            btn.className = "dynamic-option";
            btn.onclick = () => {
              selected = opt;
              btn.classList.add("selected");
              setTimeout(() => handleAnswer(opt), 200);
            };
            questionnaire.appendChild(btn);
          });
          // Option cho ph√©p nh·∫≠p t·ª± do
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = "Ho·∫∑c nh·∫≠p c√¢u tr·∫£ l·ªùi kh√°c...";
          input.style.marginTop = "10px";
          input.onkeydown = (e) => {
            if (e.key === "Enter" && input.value.trim())
              handleAnswer(input.value.trim());
          };
          questionnaire.appendChild(input);
          const btn = document.createElement("button");
          btn.textContent = idx < 4 ? "Ti·∫øp theo" : "T·∫°o b√†i vi·∫øt";
          btn.style.marginLeft = "10px";
          btn.onclick = () => {
            if (input.value.trim()) handleAnswer(input.value.trim());
          };
          questionnaire.appendChild(btn);
        } else {
          // N·∫øu kh√¥ng c√≥ option, ch·ªâ cho nh·∫≠p t·ª± do
          const input = document.createElement("input");
          input.type = "text";
          input.style.width = "80%";
          input.placeholder = "Nh·∫≠p c√¢u tr·∫£ l·ªùi...";
          input.onkeydown = (e) => {
            if (e.key === "Enter" && input.value.trim())
              handleAnswer(input.value.trim());
          };
          questionnaire.appendChild(input);
          const btn = document.createElement("button");
          btn.textContent = idx < 4 ? "Ti·∫øp theo" : "T·∫°o b√†i vi·∫øt";
          btn.style.marginLeft = "10px";
          btn.onclick = () => {
            if (input.value.trim()) handleAnswer(input.value.trim());
          };
          questionnaire.appendChild(btn);
        }
      }

      function handleAnswer(answer) {
        answers.push(answer);
        currentQuestion++;
        if (currentQuestion < 5) {
          renderQuestion(currentQuestion);
        } else {
          // N·∫øu c√¢u h·ªèi s·ªë 5 l√† v·ªÅ tone, l∆∞u l·∫°i tone ri√™ng
          if (questions[4].toLowerCase().includes("tone")) {
            tone = answer;
          }
          generateArticle();
        }
      }

      async function generateArticle() {
        questionnaire.innerHTML = `<i>ƒêang t·∫°o b√†i vi·∫øt...</i>`;
        const res = await fetch("/generate-article", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ topic: selectedTopic, answers, tone }),
        });
        const data = await res.json();
        if (data.article) {
          questionnaire.innerHTML = "";
          // N·∫øu kh√¥ng ph·∫£i HTML, chuy·ªÉn markdown sang HTML
          let html = data.article;
          if (!/<[a-z][\s\S]*>/i.test(html)) {
            html = simpleMarkdownToHtml(html);
          }
          resultDiv.innerHTML = `<b>B√†i vi·∫øt ho√†n ch·ªânh:</b><div class='article-html'>${html}</div>`;
        } else {
          questionnaire.innerHTML = "L·ªói khi t·∫°o b√†i vi·∫øt.";
        }
      }

      // H√†m chuy·ªÉn ƒë·ªïi markdown ƒë∆°n gi·∫£n sang HTML
      function simpleMarkdownToHtml(md) {
        let html = md;
        // Ti√™u ƒë·ªÅ --- ho·∫∑c **Ti√™u ƒë·ªÅ**
        html = html.replace(/^\*\*(.+?)\*\*$/gm, "<strong>$1</strong>");
        html = html.replace(/^# (.+)$/gm, "<h1>$1</h1>");
        html = html.replace(/^## (.+)$/gm, "<h2>$1</h2>");
        html = html.replace(/^### (.+)$/gm, "<h3>$1</h3>");
        // D√≤ng ---
        html = html.replace(/^---$/gm, "<hr>");
        // Danh s√°ch * ho·∫∑c -
        html = html.replace(/^[*\-] (.+)$/gm, "<li>$1</li>");
        // G·ªôp c√°c <li> li√™n ti·∫øp th√†nh <ul>
        html = html.replace(
          /(<li>.*?<\/li>\s*)+/gs,
          (m) => `<ul>${m.replace(/\s*$/, "")}</ul>`
        );
        // Xu·ªëng d√≤ng
        html = html.replace(/\n{2,}/g, "</p><p>");
        html = "<p>" + html + "</p>";
        // ƒê·∫≠m **text**
        html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
        // Nghi√™ng *text*
        html = html.replace(/\*(.+?)\*/g, "<em>$1</em>");
        // X√≥a <p> quanh <ul>
        html = html.replace(/<p>(<ul>.*?<\/ul>)<\/p>/gs, "$1");
        // X√≥a <p> quanh <hr>
        html = html.replace(/<p>(<hr>)<\/p>/g, "$1");
        return html;
      }

      window.onload = renderTopics;
    </script>
  </body>
</html>

<!-- Di chuy·ªÉn file n√†y v√†o th∆∞ m·ª•c 'public' (t·∫°o th∆∞ m·ª•c public n·∫øu ch∆∞a c√≥): -->
<!-- d:\CV_2025_half_2\AI_Writer_Assistant\public\index.html -->
